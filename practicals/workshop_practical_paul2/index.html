<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Tade Souaiaia" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Day2 (PM) - prsWorkshop</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Day2 (PM)";
        var mkdocs_page_input_path = "practicals/workshop_practical_paul2.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> prsWorkshop
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Pre-Workshop</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../prep_list/">Checklist</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../prep_os/">Operating System</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../prep_terminal/">Terminal Setup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../prep_software/">Software Installs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../prep_testing/">Testing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Pre-Workshop Tutorials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut_intro/">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut_bash/">Bash Tutorial</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut_R/">R Tutorial</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut_python/">Python Tutorial</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tut_plink/">Plink Tutorial</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Program</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../workshop_practical_paul1/">Day1 (AM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../workshop_practical_tade/">Day1 (PM)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../workshop_practical_clive/">Day2 (AM)</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Day2 (PM)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#key-learning-outcomes">Key Learning Outcomes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-structure">Data Structure</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#introduction-to-gene-set-pathway-prs-analysis">Introduction to gene set (pathway) PRS analysis</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#inputs-required-for-gene-set-prs-analysis">Inputs required for gene-set PRS analysis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#molecular-signatures-database-msigdb-general-transfer-format-file">Molecular Signatures Database MSigDB + General Transfer Format file</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#other-inputs-that-can-be-used-for-gene-set-prs-using-prset">Other inputs that can be used for gene set PRS using PRSet</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#browser-extensible-data-bed">Browser Extensible Data BED</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#list-of-snps">List of SNPs</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#exercise-calculate-gene-set-prs-analysis">Exercise: Calculate gene set PRS analysis</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#results-and-plots-specific-of-gene-set-prs-analyses">Results and Plots specific of gene set PRS analyses</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#competitive-p-value-calculation">Competitive P-value calculation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#other-considerations-when-analysing-and-interpreting-gene-set-prss">Other considerations when analysing and interpreting gene set PRSs</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#clumping-for-each-gene-set-independently">Clumping for each gene set independently</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#p-value-thresholding-in-gene-set-prs-analyses">P-value thresholding in gene set PRS analyses</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#advanced-polygenic-risk-score-analyses">Advanced Polygenic Risk Score Analyses</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#key-learning-outcomes_1">Key Learning Outcomes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-structure_1">Data Structure</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#exercise-1-estimating-r2-in-case-and-control-studies">Exercise 1: Estimating \(R^2\) in case and control studies</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#exercise-2-overfitting-caused-by-model-optimisation">Exercise 2: Overfitting caused by model optimisation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#out-of-sample-validation">Out of Sample Validation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#exercise-3-distribution-of-prs">Exercise 3: Distribution of PRS</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Misc</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../misc_linux/">Linux For Windows</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../misc_plink_problem/">Mac Security</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">prsWorkshop</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Program</li>
      <li class="breadcrumb-item active">Day2 (PM)</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/tadesouaiaia/prsWorkshop-website/edit/master/docs/practicals/workshop_practical_paul2.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="day-2-afternoon-practical-pathway-prs-analyses">Day 2 - Afternoon practical: Pathway PRS analyses</h1>
<h2 id="key-learning-outcomes">Key Learning Outcomes</h2>
<p>After completing this practical, you should be able to:</p>
<ol>
<li>Understand the motivation and rationale for calculating gene set PRS.</li>
<li>Understand the inputs required for gene set PRS analysis using PRSet. </li>
<li>Calculate gene set based PRSs using PRSet.</li>
<li>Understand and interpret the outcomes of gene set PRSs and how they differ from genome-wide PRS.</li>
</ol>
<h2 id="data-structure">Data Structure</h2>
<p>You will find all practical materials in the <a href="https://drive.google.com/drive/folders/1NNtG9_pFJZeO9pH9WOQla7wj1AU-LDon?usp=sharing">following link</a>. Relevant materials that you should find at the start of the practical are:</p>
<p>📂: Base_Data</p>
<ul>
<li>GIANT_Height.txt</li>
</ul>
<p>📂: Target_Data</p>
<ul>
<li>TAR.fam</li>
<li>TAR.bim</li>
<li>TAR.bed</li>
<li>TAR.height</li>
<li>TAR.covariate</li>
</ul>
<p>📁: Reference</p>
<ul>
<li>Homo_sapiens.GRCh38.109.gtf.gz</li>
<li>Sets.gmt</li>
</ul>
<p>📁: Software</p>
<ul>
<li>PRSice.R</li>
<li>PRSice_mac/linux</li>
</ul>
<p><a id="gene-set-analysis-intro"></a></p>
<h2 id="introduction-to-gene-set-pathway-prs-analysis">Introduction to gene set (pathway) PRS analysis</h2>
<p>Most PRS methods summarize genetic risk to a single number, based on the aggregation of an individual’s <strong>genome-wide</strong> risk alleles. This approach does not consider the different contributions of the various biological processes that can influence complex diseases and traits. </p>
<p>During this session, you will learn how to run a gene set (or pathway) based PRS analyses. The key difference between genome-wide PRS and gene set or pathway-based PRSs analyses is that, instead of aggregating the estimated effects of risk alleles across the entire genome, gene set PRSs aggregate risk alleles across as many gene sets as the user defines (Figure 1).</p>
<p><img alt="pathway PRS" src="../../images/pathwayPRS_overview.png" />
<sub> <strong>Figure 1:</strong> The pathway polygenic risk score approach. Coloured boxes represent genes, lines link genes that are within the same genomic pathway. See full description <a href="https://doi.org/10.1371/journal.pgen.1010624">here</a>.
</sub></p>
<hr />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this practical, we will go through some of the input requirements and considerations for the analysis of gene set PRS analysis, and will then calculate some gene set based PRS using <a href="https://choishingwan.github.io/PRSice/quick_start_prset/">PRSet</a>.</p>
</div>
<hr />
<p>By aggregating PRS across multiple gene sets (or pathways), these PRS analyses will allow us to determine the genetic contribution made by each biological process in complex traits and diseases. For more information about the rationale and the software that we are going to use, please see the PRSet publication <a href="https://doi.org/10.1371/journal.pgen.1010624">PRSet: Pathway-based polygenic risk score analyses and software</a>. </p>
<hr />
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ Why is it useful to have polygenic scores measured across gene-sets (or pathways) for individuals?</p>
<p>❓ Isn’t it suﬃcient to just obtain a ranking of gene-sets according to GWAS-signal enrichment (using gene set enrichment tools such as MAGMA or partitioned LDSC)?</p>
</div>
<hr />
<p><a id="prset-inputs"></a></p>
<h2 id="inputs-required-for-gene-set-prs-analysis">Inputs required for gene-set PRS analysis</h2>
<p>Summary statistics from GWAS, as well as individual level genotype and phenotype data are required to perform gene set PRS analyses. </p>
<p>In this session, the following Base and Target data is used. Base data is publicly available. All Target data in this worshop are <strong>simulated</strong>. They have no specific biological meaning and are for demonstration purposes only. </p>
<p>Additionally, to perform gene set PRS analyses, information about the gene sets for which we want to calculate the PRSs are required. In this tutorial, we will use as input gene-sets from the <strong>Molecular Signatures Database</strong> (in <code>Reference/</code>). Note that PRSet also takes as input <strong>BED and SNP files</strong>. </p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>Data Set</strong></th>
<th style="text-align: center;"><strong>Description</strong></th>
<th style="text-align: center;"><strong>Download Link</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Ensembl Human Genome GTF file</td>
<td style="text-align: center;">A file containing the coordinates for genes in the human genome. Used by PRSet to map the SNPs onto genic regions</td>
<td style="text-align: center;"><a href="https://ftp.ensembl.org/pub/release-109/gtf/homo_sapiens/">Link to Homo_sapiens.GRCh38.109.gtf.gz</a></td>
</tr>
<tr>
<td style="text-align: center;">MSigDB Gene Sets</td>
<td style="text-align: center;">File containing the gene-set information. <em>Free registration required.</em></td>
<td style="text-align: center;"><a href="http://software.broadinstitute.org/gsea/msigdb/download_file.jsp?filePath=/resources/msigdb/6.1/h.all.v6.1.symbols.gmt">Download link after registration</a></td>
</tr>
</tbody>
</table>
<p><a id="molecular-signatures-Database-msigdb"></a></p>
<h3 id="molecular-signatures-database-msigdb-general-transfer-format-file">Molecular Signatures Database MSigDB + General Transfer Format file</h3>
<p>MSigDB oﬀers an excellent source of gene sets, including the hallmark genes, gene sets of diﬀerent biological processes, gene sets of diﬀerent oncogenic signatures etc. All gene sets from MSigDB follows the Gene Matrix Transposed file format (GMT), which consists of one line per gene set, each containing at least 3 column of data:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">Set A</td>
<td style="text-align: center;">Description</td>
<td style="text-align: center;">Gene 1</td>
<td style="text-align: center;">Gene 2</td>
<td style="text-align: center;">...</td>
</tr>
<tr>
<td style="text-align: center;">Set B</td>
<td style="text-align: center;">Description</td>
<td style="text-align: center;">Gene 1</td>
<td style="text-align: center;">Gene 2</td>
<td style="text-align: center;">...</td>
</tr>
</tbody>
</table>
<hr />
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>While you can read the GMT file using Excel, we recommend exploring these files using bash. You should be aware that Excel has a tendency to convert gene names into dates (e.g. SEPT9 to Sep-9)</p>
</div>
<hr />
<p><strong>Have a look at the Reference/Sets.gmt file.</strong></p>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ How many gene sets are there in the Reference/Sets.gmt file? </p>
<p>❓ How many genes does the largest gene set contain?
 Hint: You can use the command <code>awk '{print $1"\t"NF}' Sets.gmt</code></p>
</div>
<hr />
<p>As GMT format does not contain the chromosomal location for each individual gene, an additional file (General Transfer Format file) is required to provide the chromosomal location such that SNPs can be mapped to genes.</p>
<p>The General Transfer Format (GTF) file contains the chromosomal coordinates for each gene. It is a <strong>tab</strong> separated file and all fields except the last must contain a value. You can read the full format specification <a href="https://useast.ensembl.org/info/website/upload/gff.html">here</a>. </p>
<p>Two columns in the GTF file that might be of particular interest are:
- Column 3: <strong>feature</strong>, which indicates what feature that line of GTF represents. This allows us to select or ignore features that are of interest. </p>
<ul>
<li>Column 9: <strong>attribute</strong>, which contains a semicolon-separated list of tag-value pairs (separated by a space), providing additional information about each feature. A key can be repeated multiple times.</li>
</ul>
<hr />
<p><a id="other-inputs"></a></p>
<h3 id="other-inputs-that-can-be-used-for-gene-set-prs-using-prset">Other inputs that can be used for gene set PRS using PRSet</h3>
<h4 id="browser-extensible-data-bed">Browser Extensible Data BED</h4>
<p>Browser Extensible Data (BED) file (diﬀerent to the binary ped file from PLINK), is a file format to define genetic regions. It contains 3 required fields per line (chromosome, start coordinate and end coordinate) together with 9 additional optional field. A special property of BED is that it is a 0-based format, i.e. chromosome starts at 0, as opposed to the usual 1-based format such as the PLINK format. For example, a SNP on chr1:10000 will be represented as:</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><strong>1</strong></td>
<td style="text-align: center;"><strong>9999</strong></td>
<td style="text-align: center;"><strong>10000</strong></td>
</tr>
</tbody>
</table>
<hr />
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ How should we represent the coordinate of rs2980300 (chr1:785989) in BED format?</p>
</div>
<hr />
<h4 id="list-of-snps">List of SNPs</h4>
<p>Finally, PRSet also allow SNP sets, where the user have flexibility to decide what SNPs are included. The list of SNPs can have two different formats:
- SNP list format, a file containing a single column of SNP ID. Name of the set will be the file name or can be provided using <code>--snp-set File:Name</code>
- MSigDB format: Each row represent a single SNP set with the first column containing the name of the SNP set.</p>
<p><a id="exercise-4-gene-set-based-prs-analysis"></a></p>
<h2 id="exercise-calculate-gene-set-prs-analysis">Exercise: Calculate gene set PRS analysis</h2>
<p>To perform the PRSet analysis, we need to provide the GTF file and the GMT file to PRSice. Additionally, we want to specify the number of permutation to calculate competitive P-value calculation using the --set-perm option.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>Rscript ./Software/PRSice.R \
    --prsice Software/PRSice_mac  \
    --base Base_Data/GIANT_Height.txt \
    --target Target_Data/TAR \
    --A1 Allele1 \
    --A2 Allele2 \
    --snp MarkerName \
    --pvalue p \
    --stat b \
    --beta \
    --binary-target F \
    --pheno Target_Data/TAR.height \
    --cov Target_Data/TAR.covariate \
    --out Height.set \
    --gtf Reference/Homo_sapiens.GRCh38.109.gtf.gz \
    --wind-5 5kb \
    --wind-3 1kb \
    --msigdb Reference/Sets.gmt \
    --multi-plot 10 \
    --set-perm 1000
</code></pre></div>
<hr />
<p><strong>Compare the code to calculate a genome-wide PRS with PRSice (e.g. looking at yesterday's practical) and the code above to run PRSet</strong></p>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ What extra commands are used today to run gene set specific PRSs? What do these additional commands do?</p>
</div>
<hr />
<h2 id="results-and-plots-specific-of-gene-set-prs-analyses">Results and Plots specific of gene set PRS analyses</h2>
<h3 id="competitive-p-value-calculation">Competitive P-value calculation</h3>
<p>When only one region of the genome is used to calculate PRSs (for example a gene set or a pathway PRSs), self-contained and/or competitive tests of association can be performed.</p>
<p>The null-hypothesis of self-contained and competitive test statistics is diﬀerent:
- <strong>Null-hypothesis for self-contained test</strong> - None of the genes within the gene set are associated with the phenotype.
- <strong>Null-hypothesis for competitive tests</strong> - Genes within the gene set are no more associated with the phenotype than genes outside the gene set.</p>
<p>Importantly, in a self-contained test, a bigger gene-set will have a higher likelihood of having a significant P-value from self-contained test, which is not desirable. Therefore, competitive P-values should be calculated to account for gene set size, as shown in <strong>Figure 2</strong>.</p>
<p><img alt="Figure" src="../../images/competitiveVSself-contained.png" />
<strong>Figure 2</strong> : Examples of significant and non-significant gene sets when running competitive tests of association.</p>
<hr />
<p><strong>Check the .summary results file after running PRSice WITH and WITHOUT including the PRSet specific options</strong></p>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ How does the .summary output file change? What extra information (i.e. extra columns) are incorporated when including PRSet specific commands?</p>
<p>❓ What are the 3 gene-sets with the smallest self contained P-values?</p>
<p>❓ What are the 3 gene-sets with the smallest competitive P-values? </p>
</div>
<p><strong>Imagine that you are running an analysis to find the gene sets most associated with height</strong></p>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ Considering both the competitive P-value results, what gene set do you think is the most interesting and why?</p>
</div>
<hr />
<p>In addition to additional information in the output files, running the PRSet options will provide one extra figure with the results for the gene set PRS with the highest R2.</p>
<p><img alt="Figure" src="../../images/Day2b_Height.set_MULTISET_BARPLOT.png" />
<strong>Figure 3</strong> : An example of the multi-set plot. Sets are sorted based on their self-contained R2. Base is the genome wide PRS.</p>
<p><a id="considerations"></a></p>
<h2 id="other-considerations-when-analysing-and-interpreting-gene-set-prss">Other considerations when analysing and interpreting gene set PRSs</h2>
<p><a id="clumping"></a></p>
<h3 id="clumping-for-each-gene-set-independently">Clumping for each gene set independently</h3>
<p>In standard clumping and P-value thresholding methods, clumping is performed to account for linkage disequilibrium between SNPs. However, when performing set based analysis, special care are required to perform clumping. 
Take the following as an example:
Assume that:</p>
<ul>
<li>Light Blue fragments are the intergenic regions</li>
<li>Dark Blue fragments are the genic regions</li>
<li>Red fragments are the gene set regions</li>
<li>SNPs are represented as thunder bolt, with the "index" SNP in clumping denoted by the green thunderbolt</li>
</ul>
<p>If we simply perform a genome wide clumping, we might remove all SNPs residing within the gene set of interest, 
reducing the signal:</p>
<p><img alt="Genome Wide Clumping" src="../../images/genome_wide_clump.gif" /></p>
<p>Therefore, to maximize signal within each gene set, we must perform clumping for each gene sets separately:</p>
<p><img alt="Set Base Clumping" src="../../images/set_clump.gif" /></p>
<hr />
<p><strong>Check the .summary results file (Do not count the Base, as this result corresponds to the genome-wide PRS)</strong></p>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ Can you plot the relationship between the gene set R2 and the number of SNPs in each gene set? What general trend can be seen?</p>
</div>
<hr />
<p><a id="thresholding"></a></p>
<h3 id="p-value-thresholding-in-gene-set-prs-analyses">P-value thresholding in gene set PRS analyses</h3>
<p>PRSet default option is to no not perform p-value thresholding. It will simply calculate the set based PRS at P-value threshold of 1. </p>
<hr />
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ Why do you think that the default option of PRSet is P-value threshold of 1?</p>
<p>❓ In what cases would you like to apply P-value thresholding?</p>
</div>
<hr />
<h2 id="advanced-polygenic-risk-score-analyses">Advanced Polygenic Risk Score Analyses</h2>
<h2 id="key-learning-outcomes_1">Key Learning Outcomes</h2>
<p>After completing this practical, you should be able to:</p>
<ol>
<li>Know how to adjust for ascertainment bias in case-control analysis</li>
<li>Know how over-fitting aﬀects PRS results and how to handle it </li>
<li>Understand distribution of PRS</li>
</ol>
<h2 id="data-structure_1">Data Structure</h2>
<p>Relevant materials that you should find at the start of the practical are:</p>
<p>📂: Base_Data</p>
<ul>
<li>GIANT_Height.txt</li>
<li>Cardio_CAD.txt</li>
</ul>
<p>📂: Target_Data</p>
<ul>
<li>TAR.fam</li>
<li>TAR.bim</li>
<li>TAR.bed</li>
<li>TAR.height</li>
<li>TAR.cad</li>
<li>TAR.covariate</li>
<li>VAL.fam</li>
<li>VAL.bim</li>
<li>VAL.bed</li>
<li>VAL.height</li>
<li>VAL.covariate</li>
</ul>
<p>📁: Software</p>
<ul>
<li>PRSice.R</li>
<li>PRSice_mac/linux</li>
<li>Quantile.R</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note All target phenotype data in this worshop are <strong>simulated</strong>. They have no specific biological meaning and are for demonstration purposes only. </p>
</div>
<h2 id="exercise-1-estimating-r2-in-case-and-control-studies">Exercise 1: Estimating <span class="arithmatex">\(R^2\)</span> in case and control studies</h2>
<p>Bias in <span class="arithmatex">\(R^2\)</span> estimation caused by ascertained case/control samples can be adjusted using the equation proposed by <strong>Lee et al (2011)</strong>, which requires the sample prevalence (case/control ratio) and population prevalence as parameters. This function is implemented in PRSice and the adjustment can be performed by providing the population prevalence to the command <code>--prevalence</code>.</p>
<p>Residuals of logistic regression is not well defined, and in PRS analyses, Nagelkerke <span class="arithmatex">\(R^2\)</span>  is usually used to represent the model <span class="arithmatex">\(R^2\)</span> (this is the default of PRSice). However, this <span class="arithmatex">\(R^2\)</span> does not account for the diﬀerence between sample prevalence (i.e. case-control ratio) and population prevalence, which can lead to bias in the reported <span class="arithmatex">\(R^2\)</span> (Figure 1.1a). </p>
<p><strong>Figure 1.1: Performance of diﬀerent <span class="arithmatex">\(R^2\)</span> when the study contains equal portion of cases and controls</strong></p>
<p><strong>(a) Nagelkerke <span class="arithmatex">\(R^2\)</span></strong> 
<img alt="Figure 1.1a" src="../../images/r2spread.png" /></p>
<hr />
<p>Bias in <span class="arithmatex">\(R^2\)</span> estimation caused by ascertained case/control samples can be adjusted using the equation proposed by <strong>Lee et al. 2011 (Figure 1.1b)</strong>, which requires the sample
prevalence (case/control ratio) and population prevalence as parameters. This function is implemented in PRSice and the adjustment can be performed by providing the population prevalence to the command <code>--prevalence</code>.</p>
<p><strong>Figure 1.1: Performance of diﬀerent <span class="arithmatex">\(R^2\)</span>  when the study contains equal portion of cases and controls</strong></p>
<p>**(b) Lee adjusted <span class="arithmatex">\(R^2\)</span> ** 
<img alt="Figure 1.1b" src="../../images/Lee.png" /></p>
<hr />
<p>Now, account for the ascertainment of the case/control sample by including the population prevalence (let’s assume e.g. 5% here) in the PRSice command to obtain the adjusted (Lee) <span class="arithmatex">\(R^2\)</span>  :</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>Rscript ./Software/PRSice.R \
     --prsice Software/PRSice_mac \
     --base  Base_Data/Cardio_CAD.txt  \
     --target Target_Data/TAR \
     --snp markername \
     --A1 effect_allele \
     --A2 noneffect_allele \
     --chr chr \
     --bp bp_hg19 \
     --stat beta \
     --beta \
     --pvalue p_dgc \
     --pheno Target_Data/TAR.cad \
     --prevalence 0.05 \
     --binary-target T \
     --out Results/CAD.highres.LEER2
</code></pre></div>
<p>The results are written to the "Results" directory. Examine the results folder and each file that was generated. For more information about each file type, see  <a href="https://choishingwan.github.io/PRSice/step_by_step/">here</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Check the *.summary file in the Results folder where you will find the usual (Nagelkerke) <span class="arithmatex">\(R^2\)</span>  and the adjusted (Lee) <span class="arithmatex">\(R^2\)</span> .</p>
</div>
<p><strong>Figure 1.2: Barplot of CAD Lee <span class="arithmatex">\(R^2\)</span></strong> </p>
<p><img alt="Figure 1.2" src="../../images/CAD_lee.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To speed up the practical, we have generated a smaller gene-set file. If you want the full gene-set file, you can download it from the link above.</p>
<p>All target phenotype data in this workshop are simulated. While they reflect the corresponding trait data, they have no specific biological meaning and are for demonstration purposes only.</p>
</div>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ Has accounting for the population prevalence aﬀected the <span class="arithmatex">\(R^2\)</span> ?</p>
<p>❓ Would you expect a diﬀerence between the Nagelkerke <span class="arithmatex">\(R^2\)</span>  and the Lee adjusted <span class="arithmatex">\(R^2\)</span>  if the case/control ratio in the target sample reflects the disease prevalence in the population?</p>
</div>
<hr />
<h2 id="exercise-2-overfitting-caused-by-model-optimisation">Exercise 2: Overfitting caused by model optimisation</h2>
<p>In PRS analyses, the shrinkage or tuning parameter is usually optimized across a wide range of parametric space (e.g. P -value threshold, proportion of causal SNPs). When both optimisation and association testing are performed on the target data, over-fitted results will be obtained. The accuracy and predictive power of over-fitted results are likely to diminish when replicated in an independent data set.</p>
<p>A simple solution is to perform permutation to obtain an empirical P -value for the association model, which is implemented in PRSice. Briefly, permutation is performed as follows:</p>
<ol>
<li>Compute the P -value in your original data, denoted as obs.p, at the "best" threshold.</li>
<li>Then shuﬄe the phenotype and obtain the P -value of the "best" threshold for this null phenotype, denoted as null.p</li>
<li>Repeat 2 <span class="arithmatex">\(N\)</span> times</li>
<li>Calculate the empirical P-value (<span class="arithmatex">\(P_{emp}\)</span>) as:</li>
</ol>
<p>$$
P_{emp} =  \frac{\sum_{n=1}^NI(P_{null}\lt P_observed)+1}{N+1}
$$
where <span class="arithmatex">\(I(.)\)</span> is the indicator function. </p>
<hr />
<p>You will have to specify the number of permutation (N) to perform by providing <code>--perm N</code> as a parameter to PRSice.</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>Rscript ./Software/PRSice.R \
    --prsice Software/PRSice_mac \
    --base  Base_Data/GIANT_Height.txt \
    --target Target_Data/TAR \
    --snp MarkerName \
    --A1 Allele1 \
    --A2 Allele2 \
    --stat b \
    --beta \
    --pvalue p \
    --pheno Target_Data/TAR.height \
    --binary-target F \
    --cov Target_Data/TAR.covariate \
    --cov-col Sex \
    --perm 1000 \
    --out Results/Height.perm
</code></pre></div>
<p><strong>Figure 1.3: Barplot of Height using 1000 permutations</strong></p>
<p><img alt="Figure 1.3" src="../../images/Height.perm_BARPLOT.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>10000 permutations typically provide empirical P-values with high accuracy to the second decimal place (eg. 0.05), but smaller empirical P-values should be considered approximate. </p>
</div>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ What is the smallest possible empirical P-value when 10000 permutation are performed? </p>
<p>❓ Is the height PRS significantly associated with height after accounting for the over-fitting implicit in identifying the best-fit PRS? How about CAD?</p>
</div>
<hr />
<h3 id="out-of-sample-validation">Out of Sample Validation</h3>
<p>The best way to avoid having results that are over-fit is to perform validation on an independent validation data set. We can perform validation of the previous height + covariate analysis with PRSice, using the independent VAL target sample as validation data and the "best" P-value threshold predicted in the VAL samples:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code>Rscript ./Software/PRSice.R \
     --prsice Software/PRSice_mac \
     --base  Base_Data/GIANT_Height.txt \
     --target Target_Data/VAL \
     --snp MarkerName \
     --A1 Allele1 \
     --A2 Allele2 \
     --stat b \
     --beta \
     --pvalue p \
     --pheno Target_Data/VAL.height \
     --binary-target F \
     --no-full \
     --bar-levels 0.0680001 \
     --fastscore \
     --cov Target_Data/VAL.covariate \
     --cov-col Sex \
     --out Results/Height.val
</code></pre></div>
<p><strong>Figure 1.4: Barplot of Height validation dataset</strong> 
<img alt="Figure 1.4" src="../../images/Height.val_BARPLOT.png" /></p>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ Why do we use <code>--bar-levels 0.0680001</code> <code>--no-full</code> and <code>--fastscore</code> in this script?</p>
<p>❓ How does the PRS R2 and P -value for the validation data set compare to the analysis on the TAR target data? Is this what you would expect? Why?</p>
</div>
<hr />
<h2 id="exercise-3-distribution-of-prs">Exercise 3: Distribution of PRS</h2>
<p>Many PRS study publications include quantile plots that show an exponential increase in phenotypic value or / Odd Ratios (OR) among the top quantiles (e.g. an S-shaped quantile plot, e.g. Figure 1.6). </p>
<p><strong>Figure 1.5: An example of density plot for PRS</strong>
<img alt="Figure 1.5" src="../../images/images020.png" /></p>
<hr />
<blockquote>
<p><strong>Figure 1.6: An example of a S-shaped quantile plot</strong></p>
<p><img alt="Figure 1.6" src="../../images/images021.png" /></p>
</blockquote>
<hr />
<p>This might lead us to believe that individuals with PRS values in the top quantiles have a distinctly diﬀerent genetic aetiology compared to the rest of the sample, or that there is epistasis/interactions causing there substantially higher risk. However, when we plot a normally distributed variable (e.g. a PRS) as quantiles on the X-axis then we expect to observe this exponential pattern even when the X variable only has a linear eﬀect on the Y variable. This is because the top (and bottom) quantiles are further away from each other on the absolute scale of the variable and so the diﬀerences in their eﬀects are larger than between quantiles in the middle of the distribution.</p>
<p>To understand this more, we will perform a simple simulation using R:
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><code><span style="color: #3D7B7B; font-style: italic"># First, we define some simulation parameters</span>
n.sample<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;-</span><span style="color: #bbbbbb"> </span><span style="color: #666666">10000</span>
PRS.r2<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;-</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.01</span>
<span style="color: #3D7B7B; font-style: italic"># Then, we simulate PRS that follow a random normal distribution</span>
prs<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;-</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">rnorm</span>(n.sample)
<span style="color: #3D7B7B; font-style: italic"># We can then simulate the phenotype using the following script</span>
pheno<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;-</span><span style="color: #bbbbbb"> </span>prs<span style="color: #bbbbbb"> </span><span style="color: #666666">+</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">rnorm</span>(n.sample,mean<span style="color: #666666">=0</span>,<span style="color: #bbbbbb"> </span>sd<span style="color: #666666">=</span><span style="color: #0000FF">sqrt</span>(<span style="color: #0000FF">var</span>(prs)<span style="color: #666666">*</span>(<span style="color: #666666">1-</span>PRS.r2)<span style="color: #666666">/</span>(PRS.r2)))
<span style="color: #3D7B7B; font-style: italic"># We can examine the relationship between the phenotype and prs </span>
<span style="color: #3D7B7B; font-style: italic"># using linear regression</span>
<span style="color: #0000FF">summary</span>(<span style="color: #0000FF">lm</span>(pheno<span style="color: #666666">~</span>prs))
<span style="color: #3D7B7B; font-style: italic"># Which shows that we have the expected PRS R2</span>
<span style="color: #3D7B7B; font-style: italic"># Group the phenotype and PRS into a data.frame</span>
info<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;-</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">data.frame</span>(SampleID<span style="color: #666666">=1:</span>n.sample,<span style="color: #bbbbbb"> </span>PRS<span style="color: #666666">=</span>prs,<span style="color: #bbbbbb"> </span>Phenotype<span style="color: #666666">=</span>pheno)
<span style="color: #3D7B7B; font-style: italic"># Then we can generate the quantile plot. </span>
<span style="color: #3D7B7B; font-style: italic"># To save time, we will load in the quantile plot script from Software</span>
<span style="color: #0000FF">source</span>(<span style="color: #BA2121">&quot;./Software/Quantile.R&quot;</span>)
<span style="color: #3D7B7B; font-style: italic"># Then we can plot the quantile plot using quantile_plot function</span>
<span style="color: #0000FF">quantile_plot</span>(info,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;Results/Height&quot;</span>,<span style="color: #bbbbbb"> </span><span style="color: #666666">100</span>)
</code></pre></div></p>
<blockquote>
<p><strong>Figure 1.7: The resulting quantile plot</strong></p>
<p><img alt="Figure 1.7" src="../../images/Height_QUANTILES_PLOT_2023-07-05.png" /></p>
</blockquote>
<div class="admonition questions">
<p class="admonition-title">Questions</p>
<p>❓ What is the shape of the resulting quantile plot?</p>
<p>Try plotting the densities of the height or CAD PRS in R * - do they look normally distributed? Why? (*Hint: You can generate a density plot for the PRS in R using plot(density(x)) where x is a vector of the PRS values in the sample).</p>
</div>
<p><a href="#top"><a href="#table-of-contents">Back to Top</a></a></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../workshop_practical_clive/" class="btn btn-neutral float-left" title="Day2 (AM)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../misc_linux/" class="btn btn-neutral float-right" title="Linux For Windows">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tadesouaiaia/prsWorkshop-website" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../workshop_practical_clive/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../misc_linux/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      <script src="../../javascripts/details.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
